@model CEGA.Models.ViewModels.ProyectoPageVM
@{
    ViewData["Title"] = "Proyectos";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var proyCount = Model?.Proyectos?.Count ?? 0;
    var tareaCount = Model?.Tareas?.Count ?? 0;
    var comCount = Model?.Comentarios?.Count ?? 0;
}

<!-- Header -->
<div class="mb-3 text-center">
    <h2 class="mb-1">Módulo de Proyectos</h2>
    <p class="text-muted mb-0">Gestiona proyectos, tareas y comentarios en un solo lugar.</p>
</div>

<!-- Alertas -->
@if (TempData["Mensaje"] != null)
{
    <div class="alert alert-success mb-3">@TempData["Mensaje"]</div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger  mb-3">@TempData["Error"]</div>
}

<!-- Tabs en tarjeta -->
<div class="card card-lg">
    <div class="card-header p-0">
        <ul class="nav nav-tabs card-header-tabs nav-fill" id="proyectoTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active"
                        id="proy-tab"
                        data-bs-toggle="tab"
                        data-bs-target="#proy"
                        type="button"
                        role="tab"
                        aria-controls="proy"
                        aria-selected="true">
                    Proyectos <span class="badge bg-success ms-1">@proyCount</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link"
                        id="tareas-tab"
                        data-bs-toggle="tab"
                        data-bs-target="#tareas"
                        type="button"
                        role="tab"
                        aria-controls="tareas"
                        aria-selected="false">
                    Tareas <span class="badge bg-success ms-1">@tareaCount</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link"
                        id="comentarios-tab"
                        data-bs-toggle="tab"
                        data-bs-target="#comentarios"
                        type="button"
                        role="tab"
                        aria-controls="comentarios"
                        aria-selected="false">
                    Comentarios <span class="badge bg-success ms-1">@comCount</span>
                </button>
            </li>
        </ul>
    </div>

    <div class="card-body">
        <div class="tab-content mt-2">
            <!-- PROYECTOS -->
            <div class="tab-pane fade show active" id="proy" role="tabpanel" aria-labelledby="proy-tab">
                @* Reutiliza la vista existente Listado.cshtml como parcial *@
                @await Html.PartialAsync("Listado", Model.Proyectos)
            </div>

            <!-- TAREAS -->
            <div class="tab-pane fade" id="tareas" role="tabpanel" aria-labelledby="tareas-tab">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="mb-0">Tareas</h5>
                    <div class="d-flex gap-2">
                        <a asp-controller="Tarea" asp-action="Crear" class="btn btn-sm btn-accent">Nueva tarea</a>
                        <a asp-controller="Tarea" asp-action="Index" class="btn btn-sm btn-outline-primary">Abrir módulo de tareas</a>
                    </div>
                </div>

                @* Muestra un resumen simple con los primeros elementos (evitamos depender de columnas específicas) *@
                @if (Model?.Tareas != null && Model.Tareas.Any())
                {
                    <ul class="list-group">
                        @foreach (var t in Model.Tareas.Take(10))
                        {
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Id: @t.Id</span>
                                <a asp-controller="Tarea" asp-action="Editar" asp-route-id="@t.Id" class="btn btn-sm btn-outline-secondary">Editar</a>
                            </li>
                        }
                    </ul>
                    <div class="text-end mt-2">
                        <a asp-controller="Tarea" asp-action="Index" class="btn btn-link">Ver todas</a>
                    </div>
                }
                else
                {
                    <div class="alert alert-warning mb-0">No hay tareas registradas.</div>
                }
            </div>

            <!-- COMENTARIOS -->
            <div class="tab-pane fade" id="comentarios" role="tabpanel" aria-labelledby="comentarios-tab">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="mb-0">Comentarios</h5>
                    <div class="d-flex gap-2">
                        <a asp-controller="Comentario" asp-action="Crear" class="btn btn-sm btn-accent">Nuevo comentario</a>
                        <a asp-controller="Comentario" asp-action="Index" class="btn btn-sm btn-outline-primary">Abrir módulo de comentarios</a>
                    </div>
                </div>

                @if (Model?.Comentarios != null && Model.Comentarios.Any())
                {
                    <ul class="list-group">
                        @foreach (var c in Model.Comentarios.Take(10))
                        {
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Id: @c.Id</span>
                                <a asp-controller="Comentario" asp-action="Editar" asp-route-id="@c.Id" class="btn btn-sm btn-outline-secondary">Editar</a>
                            </li>
                        }
                    </ul>
                    <div class="text-end mt-2">
                        <a asp-controller="Comentario" asp-action="Index" class="btn btn-link">Ver todos</a>
                    </div>
                }
                else
                {
                    <div class="alert alert-warning mb-0">No hay comentarios registrados.</div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}
