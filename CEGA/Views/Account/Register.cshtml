@model CEGA.Models.ViewModels.RegisterViewModel
@{
    ViewData["Title"] = "Crear cuenta";
}

<h2 class="mb-3">Crear cuenta</h2>

<form asp-action="Register" method="post" class="row g-3">
    @Html.AntiForgeryToken()

    <div asp-validation-summary="ModelOnly" class="text-danger"></div>

    <!-- Identificación -->
    <div class="col-md-4">
        <label asp-for="Cedula" class="form-label"></label>
        <input asp-for="Cedula" class="form-control" maxlength="9" />
        <span asp-validation-for="Cedula" class="text-danger"></span>
    </div>

    <!-- Nombres -->
    <div class="col-md-4">
        <label asp-for="Nombre" class="form-label"></label>
        <input asp-for="Nombre" class="form-control" />
        <span asp-validation-for="Nombre" class="text-danger"></span>
    </div>
    <div class="col-md-4">
        <label asp-for="SegundoNombre" class="form-label">Segundo nombre</label>
        <input asp-for="SegundoNombre" class="form-control" />
        <span asp-validation-for="SegundoNombre" class="text-danger"></span>
    </div>

    <!-- Apellidos -->
    <div class="col-md-4">
        <label asp-for="Apellido1" class="form-label">Apellido 1</label>
        <input asp-for="Apellido1" class="form-control" />
        <span asp-validation-for="Apellido1" class="text-danger"></span>
    </div>
    <div class="col-md-4">
        <label asp-for="Apellido2" class="form-label">Apellido 2</label>
        <input asp-for="Apellido2" class="form-control" />
        <span asp-validation-for="Apellido2" class="text-danger"></span>
    </div>

    <!-- Acceso -->
    <div class="col-md-6">
        <label asp-for="Email" class="form-label"></label>
        <input asp-for="Email" class="form-control" autocomplete="email" />
        <span asp-validation-for="Email" class="text-danger"></span>
    </div>
    <div class="col-md-6">
        <label asp-for="Password" class="form-label"></label>
        <input asp-for="Password" class="form-control" autocomplete="new-password" />
        <span asp-validation-for="Password" class="text-danger"></span>
    </div>

    <!-- Contacto -->
    <div class="col-md-6">
        <label asp-for="TelefonoPersonal" class="form-label">Teléfono personal (+506)</label>
        <div class="input-group">
            <span class="input-group-text">+506</span>
            <input asp-for="TelefonoPersonal" class="form-control" maxlength="8" />
        </div>
        <span asp-validation-for="TelefonoPersonal" class="text-danger"></span>
    </div>
    <div class="col-md-6">
        <label asp-for="TelefonoEmergencia" class="form-label">Teléfono emergencia (+506)</label>
        <div class="input-group">
            <span class="input-group-text">+506</span>
            <input asp-for="TelefonoEmergencia" class="form-control" maxlength="8" />
        </div>
        <span asp-validation-for="TelefonoEmergencia" class="text-danger"></span>
    </div>

    <!-- Perfil -->
    <div class="col-md-4">
        <label asp-for="Sexo" class="form-label"></label>
        <select asp-for="Sexo" class="form-select">
            <option value="M">M</option>
            <option value="F">F</option>
            <option value="X">X</option>
            <option value="Prefiero no decir">Prefiero no decir</option>
        </select>
        <span asp-validation-for="Sexo" class="text-danger"></span>
    </div>
    <div class="col-md-4">
        <label asp-for="FechaNacimiento" class="form-label">Fecha de nacimiento</label>
        <input asp-for="FechaNacimiento" type="date" class="form-control" />
        <span asp-validation-for="FechaNacimiento" class="text-danger"></span>
    </div>
    <div class="col-md-4">
        <label asp-for="FechaIngreso" class="form-label">Fecha de ingreso</label>
        <input asp-for="FechaIngreso" type="date" class="form-control" />
        <span asp-validation-for="FechaIngreso" class="text-danger"></span>
    </div>

    <!-- Médicos / emergencia -->
    <div class="col-md-3">
        <label asp-for="TipoSangre" class="form-label">Tipo de sangre</label>
        <input asp-for="TipoSangre" class="form-control" placeholder="O+, A-, AB..." />
        <span asp-validation-for="TipoSangre" class="text-danger"></span>
    </div>
    <div class="col-md-9">
        <label asp-for="Alergias" class="form-label"></label>
        <input asp-for="Alergias" class="form-control" />
        <span asp-validation-for="Alergias" class="text-danger"></span>
    </div>
    <div class="col-md-6">
        <label asp-for="ContactoEmergenciaNombre" class="form-label">Nombre teléfono de emergencia</label>
        <input asp-for="ContactoEmergenciaNombre" class="form-control" />
        <span asp-validation-for="ContactoEmergenciaNombre" class="text-danger"></span>
    </div>
    <div class="col-md-6">
        <label asp-for="ContactoEmergenciaTelefono" class="form-label">Teléfono emergencia (+506)</label>
        <div class="input-group">
            <span class="input-group-text">+506</span>
            <input asp-for="ContactoEmergenciaTelefono" class="form-control" maxlength="8" />
        </div>
        <span asp-validation-for="ContactoEmergenciaTelefono" class="text-danger"></span>
    </div>
    <div class="col-md-6">
        <label asp-for="PolizaSeguro" class="form-label">Numero de poliza de seguro</label>
        <input asp-for="PolizaSeguro" class="form-control" />
        <span asp-validation-for="PolizaSeguro" class="text-danger"></span>
    </div>

    <!-- Puesto -->
    @{
        var hayPuestos = Model?.Puestos != null && Model.Puestos.Any();
    }

    <div class="col-md-6">
        <label asp-for="PuestoId" class="form-label">Puesto</label>
        <div class="input-group">
            @if (hayPuestos)
            {
                <select asp-for="PuestoId"
                        asp-items="Model.Puestos"
                        class="form-select flex-grow-1"
                        id="PuestoId">
                    <option value="">— Seleccione un puesto —</option>
                </select>
            }
            else
            {
                <select asp-for="PuestoId"
                        asp-items="Model.Puestos"
                        class="form-select flex-grow-1 is-empty"
                        id="PuestoId"
                        disabled="disabled">
                    <option value="">— Sin puestos disponibles —</option>
                </select>
            }

            <button type="button"
                    class="btn btn-outline-primary"
                    data-bs-toggle="modal"
                    data-open-child="#modalNuevoPuesto">
                Nuevo
            </button>
        </div>

        @if (!hayPuestos)
        {
            <div class="form-text">Crea el primero para habilitar la selección.</div>
        }

        <span asp-validation-for="PuestoId" class="text-danger"></span>
    </div>



    <div class="col-12 d-flex gap-2">
        <button type="submit" class="btn btn-success">Crear</button>
        <a asp-controller="Account" asp-action="Login" class="btn btn-outline-secondary">Volver a login</a>
    </div>
</form>


@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        (function(){
          const form = document.getElementById('formNuevoPuesto');
          const errorBox = document.getElementById('errorNuevoPuesto');
          const select = document.getElementById('PuestoId');

          form.addEventListener('submit', async function(e){
            e.preventDefault();
            errorBox.classList.add('d-none'); errorBox.textContent = '';

            const fd = new FormData(form);
            try {
              const res = await fetch('@Url.Action("CreateInline", "Puesto")', {
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest' },
                body: fd
              });
              if (!res.ok) throw new Error(await res.text());

              const { id, nombre } = await res.json();

              // Agregar al select si no existe, y seleccionarlo
              let opt = Array.from(select.options).find(o => o.value == id);
              if (!opt) {
                opt = new Option(nombre, id, true, true);
                select.add(opt);
              } else {
                opt.selected = true;
              }

              // Cerrar modal y limpiar
        bootstrap.Modal.getOrCreateInstance(document.getElementById('modalNuevoPuesto')).hide();
                      form.reset();
              form.querySelector('input[name="Moneda"]').value = 'CRC';
              form.querySelector('#PuestoActivo').checked = true;

            } catch (err) {
              errorBox.textContent = err?.message || 'No se pudo crear el puesto.';
              errorBox.classList.remove('d-none');
            }
          });
        })();
    </script>
}

