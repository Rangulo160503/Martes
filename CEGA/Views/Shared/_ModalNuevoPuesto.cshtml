<div class="modal fade" id="modalNuevoPuesto" tabindex="-1"
     aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false"
     aria-labelledby="modalNuevoPuestoLabel">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <form id="formNuevoPuesto" class="modal-content bg-white" method="post">
            @Html.AntiForgeryToken()

            <div class="modal-header">
                <h5 class="modal-title" id="modalNuevoPuestoLabel">Crear puesto</h5>
            </div>

            <div class="modal-body">
                <div class="row g-3">

                    <!-- Codigo -->
                    <div class="col-12 col-md-4">
                        <label class="form-label">Código</label>
                        <input name="Codigo" class="form-control" maxlength="20" required />
                    </div>

                    <!-- Nombre -->
                    <div class="col-12 col-md-8">
                        <label class="form-label">Nombre</label>
                        <input name="Nombre" class="form-control" maxlength="100" required />
                    </div>

                    <!-- Departamento -->
                    <div class="col-12 col-md-6">
                        <label class="form-label">Departamento</label>
                        <input name="Departamento" class="form-control" maxlength="200" />
                    </div>

                    <!-- Nivel -->
                    <div class="col-12 col-md-6">
                        <label class="form-label">Nivel</label>
                        <input name="Nivel" class="form-control" maxlength="100" placeholder="Junior / Senior / Gerencial" />
                    </div>

                    <!-- Descripcion -->
                    <div class="col-12">
                        <label class="form-label">Descripción</label>
                        <textarea name="Descripcion" class="form-control" maxlength="500" rows="2" required></textarea>
                    </div>

                    <!-- Requisitos -->
                    <div class="col-12">
                        <label class="form-label">Requisitos</label>
                        <textarea name="Requisitos" class="form-control" maxlength="500" rows="2"></textarea>
                    </div>

                    <!-- Salario base -->
                    <div class="col-12 col-md-4">
                        <label class="form-label">Salario base</label>
                        <input name="SalarioBase" type="number" step="0.01" min="0" class="form-control" />
                    </div>

                    <!-- Moneda -->
                    <div class="col-12 col-md-4">
                        <label class="form-label">Moneda</label>
                        <input name="Moneda" class="form-control" maxlength="50" value="CRC" />
                    </div>

                    <!-- Jornada -->
                    <div class="col-12 col-md-4">
                        <label class="form-label">Jornada</label>
                        <input name="Jornada" class="form-control" maxlength="100" placeholder="Tiempo completo / Medio tiempo" />
                    </div>

                    <!-- Activo -->
                    <div class="col-12">
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" name="Activo" id="PuestoActivo" checked />
                            <label class="form-check-label" for="PuestoActivo">Activo</label>
                        </div>
                    </div>

                    <!-- Errores -->
                    <div class="col-12">
                        <div class="text-danger small d-none" id="errorNuevoPuesto"></div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-success">Guardar</button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
      const form = document.getElementById('formNuevoPuesto');
      form?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = form.querySelector('button[type="submit"]');
        btn.disabled = true;

        try {
          const res = await fetch('@Url.Action("CrearRapido", "Puesto")', {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            body: new FormData(form)
          });
          if (!res.ok) throw new Error('No se pudo guardar el puesto.');
          const { id, nombre } = await res.json(); // { id, nombre }

          const sel = document.getElementById('PuestoId');
          if (sel) {
            // 1) habilitar y limpiar placeholder si no había
            if (sel.hasAttribute('disabled')) {
              sel.removeAttribute('disabled');
              sel.classList.remove('is-empty');
              if (sel.options.length === 1 && sel.options[0].value === "") {
                sel.options[0].text = "— Seleccione un puesto —";
              }
            }

            // 2) agregar la opción nueva (y seleccionarla)
            let opt = Array.from(sel.options).find(o => o.value == id);
            if (!opt) {
              opt = new Option(nombre, id, true, true);
              sel.add(opt);
            } else {
              opt.selected = true;
            }
            sel.value = id;
            sel.dispatchEvent(new Event('change'));
          }

          // 3) cerrar modal y resetear form
          bootstrap.Modal.getOrCreateInstance(document.getElementById('modalNuevoPuesto')).hide();
          form.reset();
          form.querySelector('input[name="Moneda"]').value = 'CRC'; // default
          form.querySelector('#PuestoActivo').checked = true;       // default
        } catch (err) {
          alert(err.message || 'Error inesperado.');
        } finally {
          btn.disabled = false;
        }
      });
    });
</script>
