@* Modal global para crear Puesto *@
<div class="modal fade modal-foreground" id="modalNuevoPuesto" tabindex="-1"
     aria-hidden="true" data-bs-backdrop="false" data-bs-keyboard="false">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <form id="formNuevoPuesto" class="modal-content bg-white" method="post">
            @Html.AntiForgeryToken()

            <div class="modal-header">
                <h5 class="modal-title">Crear puesto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>

            <div class="modal-body">
                <div class="row g-3">
                    <!-- Identificación -->
                    <div class="col-12 col-sm-4">
                        <label class="form-label">Código</label>
                        <input name="Codigo" class="form-control" maxlength="20" required>
                    </div>
                    <div class="col-12 col-sm-8">
                        <label class="form-label">Nombre</label>
                        <input name="Nombre" class="form-control" maxlength="100" required>
                    </div>

                    <!-- Departamento / Nivel -->
                    <div class="col-12 col-sm-6">
                        <label class="form-label">Departamento</label>
                        <input name="Departamento" class="form-control" maxlength="200">
                    </div>
                    <div class="col-12 col-sm-6">
                        <label class="form-label">Nivel</label>
                        <input name="Nivel" class="form-control" maxlength="100" placeholder="Junior / Senior / Gerencial">
                    </div>

                    <!-- Descripción -->
                    <div class="col-12">
                        <label class="form-label">Descripción</label>
                        <textarea name="Descripcion" class="form-control" maxlength="500" rows="2" required></textarea>
                    </div>

                    <!-- Requisitos -->
                    <div class="col-12">
                        <label class="form-label">Requisitos</label>
                        <textarea name="Requisitos" class="form-control" maxlength="500" rows="2"></textarea>
                    </div>

                    <!-- Condiciones económicas -->
                    <div class="col-12 col-sm-4">
                        <label class="form-label">Salario base</label>
                        <input name="SalarioBase" type="number" step="0.01" min="0" class="form-control">
                    </div>
                    <div class="col-12 col-sm-4">
                        <label class="form-label">Moneda</label>
                        <input name="Moneda" class="form-control" maxlength="50" value="CRC">
                    </div>
                    <div class="col-12 col-sm-4">
                        <label class="form-label">Jornada</label>
                        <input name="Jornada" class="form-control" maxlength="100" placeholder="Tiempo completo / Medio tiempo">
                    </div>

                    <!-- Activo -->
                    <div class="col-12">
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" name="Activo" id="PuestoActivo" checked>
                            <label class="form-check-label" for="PuestoActivo">Activo</label>
                        </div>
                    </div>

                    <!-- Errores -->
                    <div class="col-12">
                        <div class="text-danger small d-none" id="errorNuevoPuesto"></div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-success">Guardar</button>
            </div>
        </form>
    </div>
</div>

<script>
    (function(){
      const modal = document.getElementById('modalNuevoPuesto');
      if (!modal) return;

      // 1) Oscurecer SOLO el modal padre (Register dentro de #modalDynamic)
      const parentModalContent = document.querySelector('#modalDynamic .modal-content');
      modal.addEventListener('shown.bs.modal', () => parentModalContent?.classList.add('dimmed'));
      modal.addEventListener('hidden.bs.modal', () => parentModalContent?.classList.remove('dimmed'));

      // 2) Envío AJAX para crear Puesto y actualizar el <select> del Register
      const form = modal.querySelector('#formNuevoPuesto');
      const errorBox = modal.querySelector('#errorNuevoPuesto');

      form?.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (errorBox) { errorBox.classList.add('d-none'); errorBox.textContent = ''; }

        try {
          const res = await fetch('@Url.Action("CreateInline", "Puesto")', {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            body: new FormData(form)
          });
          if (!res.ok) throw new Error(await res.text());
          const { id, nombre } = await res.json();

          // Selecciona el <select> dentro del modal de Register
          const select = document.querySelector('#modalDynamic #PuestoId') || document.getElementById('PuestoId');
          if (select) {
            let opt = Array.from(select.options).find(o => o.value == String(id));
            if (!opt) {
              opt = new Option(nombre, id, true, true);
              select.add(opt);
            } else {
              opt.selected = true;
            }
          }

          bootstrap.Modal.getInstance(modal)?.hide();
          form.reset();
          const moneda = form.querySelector('input[name="Moneda"]');
          if (moneda) moneda.value = 'CRC';
          const activo = form.querySelector('#PuestoActivo');
          if (activo) activo.checked = true;

        } catch (err) {
          if (errorBox) {
            errorBox.textContent = err?.message || 'No se pudo crear el puesto.';
            errorBox.classList.remove('d-none');
          }
        }
      });
    })();
</script>
